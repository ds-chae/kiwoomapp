	<!DOCTYPE html>
	<html lang="ko">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Account Holdings - {IP_SUFFIX}</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				padding: 20px;
				min-height: 100vh;
			}
			.container {
				max-width: 1400px;
				margin: 0 auto;
				background: white;
				border-radius: 12px;
				box-shadow: 0 10px 40px rgba(0,0,0,0.2);
				overflow: hidden;
			}
			.header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 30px;
				text-align: center;
			}
			.header h1 {
				font-size: 2.5em;
				margin-bottom: 10px;
			}
			.header p {
				font-size: 1.1em;
				opacity: 0.9;
			}
			.table-container {
				padding: 30px;
				overflow-x: auto;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				font-size: 14px;
			}
			thead {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
			}
			th {
				padding: 5px 15px 5px 8px;
				text-align: left;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				font-size: 12px;
				border-right: 1px solid rgba(255, 255, 255, 0.3);
			}
			th:last-child {
				border-right: none;
			}
			th:first-child,
			td:first-child {
				width: 110px;
				white-space: nowrap;
			}
			td {
				padding: 5px 15px 5px 8px;
				border-bottom: 1px solid #e0e0e0;
				border-right: 1px solid #e0e0e0;
			}
			td:last-child {
				border-right: none;
			}
			tbody tr {
				transition: background-color 0.2s;
			}
			tbody tr {
				cursor: pointer;
			}
			tbody tr:hover {
				background-color: #f5f5f5;
			}
			tbody tr.selected {
				background-color: #e3f2fd;
				border-left: 4px solid #667eea;
			}
			tbody tr.selected:hover {
				background-color: #bbdefb;
			}
			tbody tr:last-child td {
				border-bottom: none;
			}
			.profit-positive {
				color: #e74c3c;
				font-weight: 600;
			}
			.profit-negative {
				color: #3498db;
				font-weight: 600;
			}
			.profit-zero {
				color: #7f8c8d;
			}
			.empty-state {
				text-align: center;
				padding: 60px 20px;
				color: #7f8c8d;
			}
			.empty-state h2 {
				font-size: 2em;
				margin-bottom: 10px;
			}
			.update-section {
				padding: 30px;
				background: #f8f9fa;
				border-top: 1px solid #e0e0e0;
			}
			.update-section h2 {
				margin-bottom: 20px;
				color: #333;
			}
			.update-form {
				display: flex;
				gap: 15px;
				align-items: flex-end;
				flex-wrap: wrap;
				margin-bottom: 15px;
			}
			.form-group {
				display: flex;
				flex-direction: column;
				gap: 5px;
			}
			.form-group label {
				font-size: 12px;
				font-weight: 600;
				color: #555;
			}
			.form-group input {
				padding: 10px;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 14px;
			}
			#interested-stock-code-input {
				width: 120px;
			}
			#interested-stock-bamount-input {
				width: 120px;
			}
			#interested-stock-price-input {
				width: 120px;
			}
			#interested-stock-rate-input {
				width: 80px;
			}
			#interested-stock-gaprate-input {
				width: 80px;
			}
			#interested-stock-btype-input {
				width: 80px;
			}
			#interested-stock-color-input {
				width: 80px;
			}
			/* Remove spinner arrows from number inputs */
			#interested-stock-bamount-input::-webkit-outer-spin-button,
			#interested-stock-bamount-input::-webkit-inner-spin-button,
			#interested-stock-price-input::-webkit-outer-spin-button,
			#interested-stock-price-input::-webkit-inner-spin-button,
			#interested-stock-rate-input::-webkit-outer-spin-button,
			#interested-stock-rate-input::-webkit-inner-spin-button,
			#interested-stock-gaprate-input::-webkit-outer-spin-button,
			#interested-stock-gaprate-input::-webkit-inner-spin-button {
				-webkit-appearance: none;
				margin: 0;
			}
			#interested-stock-bamount-input[type=number],
			#interested-stock-price-input[type=number],
			#interested-stock-rate-input[type=number],
			#interested-stock-gaprate-input[type=number] {
				-moz-appearance: textfield;
			}
			.form-group input:focus {
				outline: none;
				border-color: #667eea;
			}
			.form-group select {
				padding: 10px;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 14px;
				height: auto;
			}
			.form-group select:focus {
				outline: none;
				border-color: #667eea;
			}
			.btn-update {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
			}
			.btn-update:hover {
				opacity: 0.9;
			}
			.btn-delete {
				background: #e74c3c;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
			}
			.btn-delete:hover {
				opacity: 0.9;
			}
			.btn-logout {
				background: #6c757d;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
				margin-left: auto;
			}
			.btn-logout:hover {
				opacity: 0.9;
			}
			.update-form-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				width: 100%;
				margin-bottom: 15px;
			}
			.update-form-content {
				display: flex;
				gap: 15px;
				align-items: flex-end;
				flex-wrap: wrap;
				flex: 1;
			}
			.message {
				padding: 10px;
				margin-top: 10px;
				border-radius: 4px;
				display: none;
			}
			.message.success {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.message.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.account-group {
				margin-bottom: 40px;
			}
			.account-group-header {
				background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
				color: white;
				padding: 15px 20px;
				border-radius: 8px 8px 0 0;
				font-size: 1.3em;
				font-weight: 600;
				margin-bottom: 0;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.account-group-header h2 {
				margin: 0;
				font-size: 1.2em;
			}
			.account-auto-sell-btn {
				background: rgba(255, 255, 255, 0.2);
				color: white;
				border: 1px solid rgba(255, 255, 255, 0.3);
				padding: 6px 15px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
				font-weight: 600;
				transition: background-color 0.2s;
			}
			.account-auto-sell-btn:hover {
				background: rgba(255, 255, 255, 0.3);
			}
			.account-auto-sell-btn.enabled {
				background: #27ae60;
				border-color: #27ae60;
			}
			.account-auto-sell-btn.disabled {
				background: rgba(255, 255, 255, 0.1);
			}
			.account-group table {
				border-radius: 0 0 8px 8px;
				overflow: hidden;
			}
			.account-group table thead {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			}
			.miche-section {
				margin-top: 40px;
				padding-top: 30px;
				border-top: 2px solid #e0e0e0;
			}
			.miche-section h2 {
				color: #333;
				margin-bottom: 20px;
				font-size: 1.5em;
			}
			.interested-stocks-section {
				margin-top: 40px;
				padding-top: 30px;
				border-top: 2px solid #e0e0e0;
			}
			.interested-stocks-section h2 {
				color: #333;
				margin-bottom: 20px;
				font-size: 1.5em;
			}
			.add-interested-form {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
			}
			.add-interested-form h3 {
				margin-bottom: 15px;
				color: #333;
				font-size: 1.2em;
			}
			.add-interested-form-content {
				display: flex;
				gap: 15px;
				align-items: flex-end;
				flex-wrap: wrap;
			}
			.btn-add-interested {
				background: #3498db;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
			}
			.btn-add-interested:hover {
				background: #2980b9;
			}
			.btn-buy-interested {
				background: #27ae60;
				color: white;
				border: none;
				padding: 6px 12px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
				font-weight: 600;
				transition: background-color 0.2s;
			}
			.btn-buy-interested:hover {
				background: #229954;
			}
			.btn-remove-interested {
				background: #e74c3c;
				color: white;
				border: none;
				padding: 4px 8px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
				font-weight: 600;
			}
			.btn-remove-interested:hover {
				background: #c0392b;
			}
			.color-select {
				padding: 4px 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 14px;
				cursor: pointer;
			}
			.color-select:focus {
				outline: none;
				border-color: #667eea;
			}
			#interested-stocks-container tbody tr {
				cursor: pointer;
			}
			#interested-stocks-container tbody tr:hover {
				background-color: #f5f5f5;
			}
			#interested-stocks-container tbody tr.selected {
				background-color: #e3f2fd;
				border-left: 4px solid #667eea;
			}
			#interested-stocks-container tbody tr.selected:hover {
				background-color: #bbdefb;
			}
			#interested-stocks-container {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
				width: auto;
				display: inline-block;
			}
			#interested-stocks-container table {
				min-width: 600px;
				width: auto;
			}
			/* Increase stock name width in interested stocks section (2nd column) to prevent wrapping */
			#interested-stocks-container table th:nth-child(2),
			#interested-stocks-container table td:nth-child(2) {
				width: 200px;
				min-width: 200px;
				white-space: nowrap;
				overflow: hidden;
			}
			/* Fix column widths in interested stocks section */
			#interested-stocks-container table th:nth-child(3),
			#interested-stocks-container table td:nth-child(3) {
				width: 60px;
				max-width: 60px;
				min-width: 60px;
				white-space: nowrap;
				overflow: hidden;
			}
			#interested-stocks-container table th:nth-child(4),
			#interested-stocks-container table td:nth-child(4) {
				width: 60px;
				max-width: 60px;
				min-width: 60px;
				white-space: nowrap;
				overflow: hidden;
			}
			#interested-stocks-container table th:nth-child(6),
			#interested-stocks-container table td:nth-child(6) {
				width: 80px;
				max-width: 80px;
				min-width: 80px;
				white-space: nowrap;
				overflow: hidden;
			}
			#interested-stocks-container table th:nth-child(7),
			#interested-stocks-container table td:nth-child(7) {
				width: 50px;
				max-width: 50px;
				min-width: 50px;
				white-space: nowrap;
				overflow: hidden;
			}
			#interested-stocks-container table th:nth-child(8),
			#interested-stocks-container table td:nth-child(8) {
				width: 40px;
				max-width: 40px;
				min-width: 40px;
				white-space: nowrap;
				overflow: hidden;
			}
			/* Fix BAmount column width to 8 digits */
			#interested-stocks-container table th:nth-child(5),
			#interested-stocks-container table td:nth-child(5) {
				width: 80px;
				max-width: 80px;
				min-width: 80px;
				white-space: nowrap;
				overflow: hidden;
			}
			/* Fix Action column width to 6 digits */
			#interested-stocks-container table th:nth-child(9),
			#interested-stocks-container table td:nth-child(9) {
				width: 60px;
				max-width: 60px;
				min-width: 60px;
				white-space: nowrap;
				overflow: hidden;
			}
			@media screen and (max-width: 1600px) {
				#interested-stocks-container {
					overflow-x: auto;
					width: 100%;
					-webkit-overflow-scrolling: touch;
					display: block;
				}
				#interested-stocks-container table {
					min-width: 600px;
					width: auto;
				}
			}
			.btn-cancel {
				background: #e74c3c;
				color: white;
				border: none;
				padding: 6px 12px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
				font-weight: 600;
				transition: background-color 0.2s;
			}
			.btn-cancel:hover {
				background: #c0392b;
			}
			.btn-cancel:disabled {
				background: #95a5a6;
				cursor: not-allowed;
			}
			.btn-delete-row {
				background: #e74c3c;
				color: white;
				border: none;
				padding: 4px 8px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				transition: background-color 0.2s;
			}
			.btn-delete-row:hover {
				background: #c0392b;
			}
			.miche-row:hover {
				background-color: #f5f5f5;
			}
			.miche-row.selected {
				background-color: #e3f2fd;
				border-left: 4px solid #667eea;
			}
			.miche-row.selected:hover {
				background-color: #bbdefb;
			}
			/* Sell Price Edit Area */
			.sell-price-edit-area {
				display: none;
				background-color: #f9f9f9;
				border-top: 2px solid #667eea;
				padding: 15px;
			}
			.sell-price-edit-area.show {
				display: table-row;
			}
			.sell-price-edit-area td {
				padding: 10px;
				border-top: 1px solid #ddd;
			}
			.sell-price-edit-form {
				display: flex;
				flex-wrap: wrap;
				gap: 15px;
				align-items: center;
			}
			.sell-price-edit-form label {
				font-weight: 600;
				color: #555;
				margin-right: 5px;
			}
			.sell-price-edit-form input {
				padding: 6px 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				font-size: 14px;
				width: 120px;
				text-align: right;
			}
			.sell-price-edit-form input:focus {
				outline: none;
				border-color: #667eea;
			}
			.sell-price-edit-buttons {
				display: flex;
				gap: 10px;
			}
			.btn-apply-sell-price {
				background: #667eea;
				color: white;
				border: none;
				padding: 6px 16px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
				transition: background-color 0.2s;
			}
			.btn-apply-sell-price:hover {
				background: #5568d3;
			}
			.btn-cancel-sell-price {
				background: #95a5a6;
				color: white;
				border: none;
				padding: 6px 16px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
				transition: background-color 0.2s;
			}
			.btn-cancel-sell-price:hover {
				background: #7f8c8d;
			}
			@media (max-width: 768px) {
				.sell-price-edit-form {
					flex-direction: row;
					flex-wrap: nowrap;
					gap: 8px;
					align-items: center;
				}
				.sell-price-edit-form > div {
					display: flex;
					flex-direction: column;
					align-items: flex-start;
					gap: 2px;
				}
				.sell-price-edit-form label {
					font-size: 11px;
					margin-right: 0;
					white-space: nowrap;
				}
				.sell-price-edit-form input {
					width: 60px;
					min-width: 60px;
					max-width: 60px;
					padding: 4px 6px;
					font-size: 12px;
					text-align: right;
				}
				.sell-price-edit-buttons {
					gap: 6px;
				}
				.btn-apply-sell-price,
				.btn-cancel-sell-price {
					padding: 4px 10px;
					font-size: 12px;
					white-space: nowrap;
				}
			}

			/* Stock Price Info Dialog */
			.stock-price-dialog {
				display: none;
				position: fixed;
				z-index: 10000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
				overflow: auto;
			}
			.stock-price-dialog.show {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.stock-price-dialog-content {
				background-color: #fff;
				margin: 15% auto;
				padding: 20px;
				border: 1px solid #888;
				border-radius: 8px;
				width: 90%;
				max-width: 500px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			}
			.stock-price-dialog-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
				padding-bottom: 10px;
				border-bottom: 2px solid #667eea;
			}
			.stock-price-dialog-header h2 {
				margin: 0;
				color: #333;
				font-size: 20px;
			}
			.stock-price-dialog-close {
				color: #aaa;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
				line-height: 1;
			}
			.stock-price-dialog-close:hover,
			.stock-price-dialog-close:focus {
				color: #000;
			}
			.stock-price-info-item {
				display: flex;
				justify-content: space-between;
				padding: 10px 0;
				border-bottom: 1px solid #eee;
			}
			.stock-price-info-item:last-child {
				border-bottom: none;
			}
			.stock-price-info-label {
				font-weight: 600;
				color: #555;
			}
			.stock-price-info-value {
				color: #333;
				font-size: 16px;
			}
			.stock-price-dialog-loading {
				text-align: center;
				padding: 20px;
				color: #666;
			}
			.stock-price-dialog-error {
				text-align: center;
				padding: 20px;
				color: #e74c3c;
			}

			#miche-container {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
			}
			#miche-container table {
				width: auto !important;
			}
			#miche-container table th:nth-child(1),
			#miche-container table td:nth-child(1) {
				width: 80px;
				min-width: 70px;
			}
			/* Increase font size for account cells in orders section */
			#miche-container table td.account-cell {
				font-size: 16px;
				font-weight: 600;
			}
			#miche-container table th:nth-child(2),
			#miche-container table td:nth-child(2) {
				width: 80px;
				max-width: 80px;
				min-width: 80px;
			}
			#miche-container table th:nth-child(4),
			#miche-container table td:nth-child(4) {
				width: 80px;
			}
			#miche-container table th:nth-child(5),
			#miche-container table td:nth-child(5) {
				width: 160px;
				text-align: right;
			}
			#miche-container table th:nth-child(7),
			#miche-container table td:nth-child(7) {
				width: 80px;
				text-align: right;
			}
			#miche-container table th:nth-child(6),
			#miche-container table td:nth-child(6) {
				width: 150px;
				text-align: right;
			}
			#miche-container table th:nth-child(8),
			#miche-container table td:nth-child(8) {
				width: 60px;
			}
			#miche-container table th:nth-child(9),
			#miche-container table td:nth-child(9) {
				width: 60px;
			}
			@media screen and (max-width: 1600px) {
				#miche-container {
					overflow-x: auto;
					width: 100%;
					-webkit-overflow-scrolling: touch;
				}
				#miche-container table {
					min-width: 600px;
					width: 100%;
				}
				/* Reduce header height and match table width for orders section in mobile */
				#miche-container .account-group-header {
					padding: 8px 15px;
					font-size: 1.1em;
					width: 100%;
					box-sizing: border-box;
				}
				#miche-container .account-group-header h2 {
					font-size: 1em;
					margin: 0;
				}
				/* Change "Account:" to "ACCT:" in mobile for account group headers */
				.account-group-header h2.account-header-text {
					font-size: 1em;
				}
				/* Limit ACCT column width to 4 digits in mobile (approximately 70px for 4 digits) */
				#miche-container table th:first-child,
				#miche-container table td:first-child {
					width: 70px;
					max-width: 70px;
					min-width: 70px;
					overflow: hidden;
					white-space: nowrap;
					font-size: 12px;
				}
				/* Fix code column width to 6 digits in orders section (2nd column) */
				#miche-container table th:nth-child(2),
				#miche-container table td:nth-child(2) {
					width: 70px;
					max-width: 70px;
					min-width: 70px;
					white-space: nowrap;
				}
				/* Increase stock name width in orders section (3rd column) to prevent wrapping */
				#miche-container table th:nth-child(3),
				#miche-container table td:nth-child(3) {
					width: 200px;
					min-width: 200px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Fix TYPE column width to 6 digits in orders section (4th column) in mobile */
				#miche-container table th:nth-child(4),
				#miche-container table td:nth-child(4) {
					width: 60px;
					max-width: 60px;
					min-width: 60px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Increase ORDER/CURRENT column width by 2 digits in orders section (6th column) in mobile */
				#miche-container table th:nth-child(6),
				#miche-container table td:nth-child(6) {
					width: 170px;
					max-width: 170px;
					min-width: 170px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Increase stock name width in account holdings section (2nd column) to prevent wrapping */
				.account-group table th:nth-child(2),
				.account-group table td:nth-child(2) {
					width: 200px;
					min-width: 200px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Fix Qty column width to 8 digits in account holdings section (3rd column) in mobile */
				.account-group table th:nth-child(3),
				.account-group table td:nth-child(3) {
					width: 90px;
					max-width: 90px;
					min-width: 90px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Fix Avg Buy Price column width to 18 digits in account holdings section (4th column) in mobile */
				.account-group table th:nth-child(4),
				.account-group table td:nth-child(4) {
					width: 180px;
					max-width: 180px;
					min-width: 180px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Fix PRESET PRC/RATE column width to 10 digits in account holdings section (6th column) in mobile */
				.account-group table th:nth-child(6),
				.account-group table td:nth-child(6) {
					width: 100px;
					max-width: 100px;
					min-width: 100px;
					white-space: nowrap;
					overflow: hidden;
				}
				/* Decrease left padding of account holdings section in mobile */
				.table-container {
					padding-left: 10px;
					padding-right: 10px;
				}
				.account-group {
					padding-left: 0;
				}
				/* Increase width of title area (header) of account holdings section in mobile */
				.account-group-header {
					width: calc(100% + 100px);
					min-width: calc(100% + 100px);
					box-sizing: border-box;
					white-space: nowrap;
				}
				.account-group-header h2.account-header-text {
					white-space: nowrap;
					overflow: hidden;
					text-overflow: ellipsis;
				}
				/* Fix buy section input widths in mobile */
				#buy-section #buy-stock-code-input {
					width: 80px;
					max-width: 80px;
					min-width: 80px;
				}
				#buy-section #buy-price-input {
					width: 80px;
					max-width: 80px;
					min-width: 80px;
				}
				#buy-section #buy-amount-input {
					width: 80px;
					max-width: 80px;
					min-width: 80px;
				}
				#buy-section #buy-stock-name-input {
					width: 160px;
					max-width: 160px;
					min-width: 160px;
				}
			}
			.auto-sell-control {
				display: flex;
				align-items: center;
				gap: 10px;
			}
			.auto-sell-select {
				padding: 6px;
				border-radius: 4px;
				border: 1px solid #ddd;
				font-weight: 600;
			}
			.btn-apply-auto-sell {
				background: #34495e;
				color: white;
				border: none;
				padding: 6px 12px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				transition: background-color 0.2s;
			}
			.btn-apply-auto-sell:hover {
				background: #2c3e50;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
					<div>
						<h1 id="headline-time">Account -</h1>
						<p>Stock Holdings and Trading Information</p>
					</div>
					<div style="display: flex; gap: 10px; align-items: center;">
						<a href="/stock/data" class="btn-logout" style="text-decoration: none; display: inline-block;">Data</a>
						<button class="btn-logout" onclick="logout()">Logout</button>
					</div>
				</div>
			</div>
			<div class="table-container" id="table-container">
				<div class="empty-state">
					<h2>Loading...</h2>
					<p>Loading account holdings...</p>
				</div>
			</div>
			<div class="miche-section" id="miche-section">
				<div id="miche-container">
					<div class="account-group">
						<div class="account-group-header">
							<h2>Unexecuted Orders</h2>
						</div>
						<table>
							<thead>
								<tr>
									<th>Code</th>
									<th>Name</th>
									<th>TYPE</th>
									<th>Order Qty</th>
									<th>Order / Current</th>
									<th>REMAIN</th>
									<th>Exchange</th>
									<th>Time</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
										Loading...
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="interested-stocks-section" id="interested-stocks-section">
				<h2>Int Stocks</h2>
				<div class="add-interested-form">
					<div class="add-interested-form-content">
						<div class="form-group">
							<label for="interested-stock-code-input">Code</label>
							<input type="text" id="interested-stock-code-input" placeholder="e.g., 005930" />
						</div>
						<div class="form-group">
							<input type="text" id="interested-stock-name-input" placeholder="e.g., Samsung Electronics" />
						</div>
						<div class="form-group">
							<select id="interested-stock-btype-input">
								<option value="">Btype</option>
								<option value="CL">CL</option>
								<option value="PCL">PCL</option>
								<option value="HCL">HCL</option>
								<option value="SCL">SCL</option>
							</select>
						</div>
						<div class="form-group">
							<select id="interested-stock-color-input">
								<option value="">Color</option>
								<option value="R">빨 (Red)</option>
								<option value="O">주 (Orange)</option>
								<option value="Y">노 (Yellow)</option>
								<option value="G">초 (Green)</option>
								<option value="B">파 (Blue)</option>
								<option value="D">남 (Navy)</option>
								<option value="V">보 (Purple)</option>
							</select>
						</div>
						<div class="form-group">
							<input type="number" id="interested-stock-bamount-input" placeholder="BAmount" step="1" />
						</div>
						<div class="form-group">
							<input type="number" id="interested-stock-price-input" placeholder="Price" step="0.01" />
						</div>
						<div class="form-group">
							<input type="number" id="interested-stock-rate-input" placeholder="Rate (%)" step="0.01" />
						</div>
						<div class="form-group">
							<input type="number" id="interested-stock-gaprate-input" placeholder="GapRate" step="0.01" />
						</div>
						<button class="btn-add-interested" onclick="addInterestedStock()">Add/Update</button>
						<button class="btn-delete" onclick="deleteInterestedStockFromForm()">Delete</button>
					</div>
				</div>
				<div id="interested-stocks-container">
					<div class="account-group">
						<table>
							<thead>
								<tr>
									<th>Code</th>
									<th>Name</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="3" style="text-align: center; padding: 20px; color: #7f8c8d;">
										Loading...
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="buy-section" id="buy-section" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
					<h3>Buy</h3>
					<div class="add-interested-form-content">
						<div class="form-group">
							<label for="buy-stock-code-input">Code</label>
							<input type="text" id="buy-stock-code-input" placeholder="e.g., 005930" maxlength="8" />
						</div>
						<div class="form-group">
							<label for="buy-stock-name-input">Name</label>
							<input type="text" id="buy-stock-name-input" placeholder="e.g., Samsung Electronics" maxlength="20" readonly />
						</div>
						<div class="form-group">
							<label for="buy-price-input">Price</label>
							<input type="number" id="buy-price-input" placeholder="Price" step="0.01" min="0" maxlength="6" />
						</div>
						<div class="form-group">
							<label for="buy-amount-input">Amount</label>
							<input type="number" id="buy-amount-input" placeholder="amount" step="1" min="1" maxlength="8" />
						</div>
						<div class="form-group">
							<label>Account</label>
							<div id="buy-account-checkboxes" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; min-height: 42px; padding: 10px 0;">
								<!-- Account checkboxes will be populated here -->
							</div>
						</div>
						<button class="btn-buy-interested" onclick="buyStock()" title="Buy stock">
							Buy
						</button>
					</div>
				</div>
			</div>
			</div>
		</div>
		<script>
		
		function getProfitClass(profitRate) {
			const profitValue = parseFloat(profitRate.replace('%', '').replace('+', ''));
			if (profitValue > 0) return 'profit-positive';
			if (profitValue < 0) return 'profit-negative';
			return 'profit-zero';
		}
		
		function createRow(item) {
			const rowId = item.account + '_' + item.stock_code;
			const profitClass = getProfitClass(item.profit_rate);
			const rmndQty = item.rmnd_qty || '0';
			return `
				<tr data-row-id="${rowId}" data-stock-code="${item.stock_code}" data-stock-name="${item.stock_name}" data-preset-price="${item.preset_sell_price}" data-avg-buy-price="${item.avg_buy_price}" onclick="selectRow(this)">
					<td>${item.account}</td>
					<td><strong>${item.stock_code}</strong></td>
					<td>${item.stock_name}</td>
					<td>${item.tradeable_qty} / ${rmndQty}</td>
					<td>${item.avg_buy_price}</td>
					<td class="${profitClass}">${item.profit_rate}</td>
					<td>${item.preset_sell_price}</td>
				</tr>
			`;
		}
		
		function selectRow(rowElement) {
			// Remove selected class from all rows
			document.querySelectorAll('tbody tr').forEach(tr => {
				tr.classList.remove('selected');
			});
			
			// Add selected class to clicked row
			rowElement.classList.add('selected');
			
			// Get stock code, stock name, sell price, and sell rate from row
			const stockCode = rowElement.getAttribute('data-stock-code');
			const stockName = rowElement.getAttribute('data-stock-name') || '';
			const sellPrice = rowElement.getAttribute('data-sell-price') || '';
			const sellRate = rowElement.getAttribute('data-sell-rate') || '';
			let avgBuyPrice = rowElement.getAttribute('data-avg-buy-price') || '';
			
			// If data-avg-buy-price attribute is missing, try to get it from the table cell (4th column)
			if (!avgBuyPrice) {
				const cells = rowElement.querySelectorAll('td');
				if (cells.length >= 4) {
					avgBuyPrice = cells[3].textContent.trim();
				}
			}
			
			// Extract current price from avg_buy_price (format: "avg / current" or "- / current")
			let currentPrice = '';
			if (avgBuyPrice && avgBuyPrice.includes('/')) {
				const parts = avgBuyPrice.split('/');
				if (parts.length === 2) {
					const currentPart = parts[1].trim().replace(/,/g, '');
					if (currentPart && currentPart !== '-' && currentPart !== '') {
						currentPrice = currentPart;
					}
				}
			}
			
			// Fill buy section
			document.getElementById('buy-stock-code-input').value = stockCode;
			document.getElementById('buy-stock-name-input').value = stockName;
			// Fill with current price if available
			if (currentPrice) {
				document.getElementById('buy-price-input').value = currentPrice;
			} else {
				document.getElementById('buy-price-input').value = '';
			}
			document.getElementById('buy-amount-input').value = '';
			
			// Fill int stocks section
			document.getElementById('interested-stock-code-input').value = stockCode;
			document.getElementById('interested-stock-name-input').value = stockName;
			if (sellPrice && sellPrice !== '-') {
				const priceValue = sellPrice.replace(/,/g, '');
				document.getElementById('interested-stock-price-input').value = priceValue;
			} else {
				document.getElementById('interested-stock-price-input').value = '';
			}
			if (sellRate && sellRate !== '-') {
				// Extract percentage value (from Account Holdings table format like "5.5%")
				const rateMatch = sellRate.match(/([\d.+-]+)%/);
				if (rateMatch) {
					// Store percentage as-is (no conversion)
					document.getElementById('interested-stock-rate-input').value = rateMatch[1];
				} else {
					document.getElementById('interested-stock-rate-input').value = '';
				}
			} else {
				document.getElementById('interested-stock-rate-input').value = '';
			}
			document.getElementById('interested-stock-gaprate-input').value = '';
			
			// Scroll to update section
			
			// Show/hide input area for editing sell price/rate/sellgap
			// Remove any existing edit areas
			document.querySelectorAll('.sell-price-edit-area').forEach(area => {
				area.remove();
			});
			
			// Check if edit area already exists for this row
			const existingEditArea = rowElement.nextElementSibling;
			if (existingEditArea && existingEditArea.classList.contains('sell-price-edit-area')) {
				// Toggle: if already showing, hide it
				existingEditArea.remove();
			} else {
				// Create new edit area
				const editArea = document.createElement('tr');
				editArea.className = 'sell-price-edit-area show';
				
				// Get sellgap, sellrate, and bamount from interested_stocks if available
				let sellgap = '';
				let sellrateFromAPI = '';
				let bamount = '';
				fetch('./api/interested-stocks?t=' + Date.now())
					.then(response => response.json())
					.then(result => {
						if (result.status === 'success' && result.data && result.data[stockCode]) {
							sellgap = result.data[stockCode].sellgap || '';
							sellrateFromAPI = result.data[stockCode].sellrate || '';
							bamount = result.data[stockCode].bamount || '';
						}
						
						// Use sellrate from API if available, otherwise use from row attribute
						const finalSellRate = sellrateFromAPI || sellRate || '';
						
						// Create edit form
						editArea.innerHTML = `
							<td colspan="7">
								<div class="sell-price-edit-form">
									<div>
										<label>Sell Price:</label>
										<input type="number" id="edit-sell-price-${stockCode}" placeholder="Price" step="0.01" value="${sellPrice || ''}">
									</div>
									<div>
										<label>Sell Rate (%):</label>
										<input type="number" id="edit-sell-rate-${stockCode}" placeholder="Rate" step="0.01" value="${finalSellRate || ''}">
									</div>
									<div>
										<label>Sell Gap:</label>
										<input type="number" id="edit-sell-gap-${stockCode}" placeholder="Gap" step="0.01" value="${sellgap || ''}">
									</div>
									<div>
										<label>BAmount:</label>
										<input type="number" id="edit-bamount-${stockCode}" placeholder="BAmount" step="1" value="${bamount || ''}">
									</div>
									<div class="sell-price-edit-buttons">
										<button class="btn-apply-sell-price" onclick="applySellPriceEdit('${stockCode}', '${stockName}')">Apply</button>
										<button class="btn-cancel-sell-price" onclick="cancelSellPriceEdit('${stockCode}')">Cancel</button>
									</div>
								</div>
							</td>
						`;
						
						// Insert after the clicked row
						rowElement.parentNode.insertBefore(editArea, rowElement.nextSibling);
						
						// Add select-all on click for input fields
						const priceInput = document.getElementById(`edit-sell-price-${stockCode}`);
						const rateInput = document.getElementById(`edit-sell-rate-${stockCode}`);
						const gapInput = document.getElementById(`edit-sell-gap-${stockCode}`);
						const bamountInput = document.getElementById(`edit-bamount-${stockCode}`);
						
						if (priceInput) {
							priceInput.addEventListener('click', function() { this.select(); });
							priceInput.addEventListener('focus', function() { this.select(); });
						}
						if (rateInput) {
							rateInput.addEventListener('click', function() { this.select(); });
							rateInput.addEventListener('focus', function() { this.select(); });
						}
						if (gapInput) {
							gapInput.addEventListener('click', function() { this.select(); });
							gapInput.addEventListener('focus', function() { this.select(); });
						}
						if (bamountInput) {
							bamountInput.addEventListener('click', function() { this.select(); });
							bamountInput.addEventListener('focus', function() { this.select(); });
						}
					})
					.catch(error => {
						console.error('Error fetching sellgap and sellrate:', error);
						// Still create edit area without sellgap and sellrate from API
						// Use sellRate from row attribute as fallback
						editArea.innerHTML = `
							<td colspan="7">
								<div class="sell-price-edit-form">
									<div>
										<label>Sell Price:</label>
										<input type="number" id="edit-sell-price-${stockCode}" placeholder="Price" step="0.01" value="${sellPrice || ''}">
									</div>
									<div>
										<label>Sell Rate (%):</label>
										<input type="number" id="edit-sell-rate-${stockCode}" placeholder="Rate" step="0.01" value="${sellRate || ''}">
									</div>
									<div>
										<label>Sell Gap:</label>
										<input type="number" id="edit-sell-gap-${stockCode}" placeholder="Gap" step="0.01" value="">
									</div>
									<div>
										<label>BAmount:</label>
										<input type="number" id="edit-bamount-${stockCode}" placeholder="BAmount" step="1" value="">
									</div>
									<div class="sell-price-edit-buttons">
										<button class="btn-apply-sell-price" onclick="applySellPriceEdit('${stockCode}', '${stockName}')">Apply</button>
										<button class="btn-cancel-sell-price" onclick="cancelSellPriceEdit('${stockCode}')">Cancel</button>
									</div>
								</div>
							</td>
						`;
						rowElement.parentNode.insertBefore(editArea, rowElement.nextSibling);
						
						// Add select-all on click for input fields
						const priceInput = document.getElementById(`edit-sell-price-${stockCode}`);
						const rateInput = document.getElementById(`edit-sell-rate-${stockCode}`);
						const gapInput = document.getElementById(`edit-sell-gap-${stockCode}`);
						const bamountInput = document.getElementById(`edit-bamount-${stockCode}`);
						
						if (priceInput) {
							priceInput.addEventListener('click', function() { this.select(); });
							priceInput.addEventListener('focus', function() { this.select(); });
						}
						if (rateInput) {
							rateInput.addEventListener('click', function() { this.select(); });
							rateInput.addEventListener('focus', function() { this.select(); });
						}
						if (gapInput) {
							gapInput.addEventListener('click', function() { this.select(); });
							gapInput.addEventListener('focus', function() { this.select(); });
						}
						if (bamountInput) {
							bamountInput.addEventListener('click', function() { this.select(); });
							bamountInput.addEventListener('focus', function() { this.select(); });
						}
					});
			}
		}
		
		function deleteRowSellPrice(stockCode, stockName) {
			if (!stockCode) {
				showMessage('Stock code is missing', 'error');
				return;
			}
			
			if (!confirm(`Delete sell price/rate for ${stockName || stockCode}?`)) {
				return;
			}
			
			fetch('./api/sell-prices/' + encodeURIComponent(stockCode), {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
				}
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					showMessage('Sell price/rate deleted successfully!', 'success');
					// Refresh the tables immediately
					updateTable();
					updateSellPrices();
				} else {
					showMessage('Error: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error deleting sell price/rate: ' + error, 'error');
			});
		}
		
		function selectMicheRow(rowElement) {
			// Remove selected class from all miche rows
			document.querySelectorAll('.miche-row').forEach(tr => {
				tr.classList.remove('selected');
			});
			
			// Remove selected class from all holdings rows
			document.querySelectorAll('tbody tr:not(.miche-row)').forEach(tr => {
				tr.classList.remove('selected');
			});
			
			// Add selected class to clicked row
			rowElement.classList.add('selected');
			
			// Get stock code, stock name, and order price from row
			const stockCode = rowElement.getAttribute('data-stock-code');
			const stockName = rowElement.getAttribute('data-stock-name') || '';
			const orderPrice = rowElement.getAttribute('data-order-price') || '';
			const currentPrice = rowElement.getAttribute('data-current-price') || '';
			
			// Fill buy section
			document.getElementById('buy-stock-code-input').value = stockCode;
			document.getElementById('buy-stock-name-input').value = stockName;
			
			// Fill with current price if available, otherwise fallback to order price
			if (currentPrice && currentPrice !== '0' && currentPrice !== '') {
				document.getElementById('buy-price-input').value = currentPrice;
			} else if (orderPrice && orderPrice !== '0' && orderPrice !== '') {
				document.getElementById('buy-price-input').value = orderPrice;
			} else {
				document.getElementById('buy-price-input').value = '';
			}
			document.getElementById('buy-amount-input').value = '';
			
			// Fill int stocks section
			document.getElementById('interested-stock-code-input').value = stockCode;
			document.getElementById('interested-stock-name-input').value = stockName;
			if (currentPrice && currentPrice !== '0' && currentPrice !== '') {
				document.getElementById('interested-stock-price-input').value = currentPrice;
			} else if (orderPrice && orderPrice !== '0' && orderPrice !== '') {
				document.getElementById('interested-stock-price-input').value = orderPrice;
			} else {
				document.getElementById('interested-stock-price-input').value = '';
			}
			document.getElementById('interested-stock-rate-input').value = '';
			document.getElementById('interested-stock-gaprate-input').value = '';
		}
		
		function updateTable() {
			// Fetch both account data and auto sell status in parallel
			Promise.all([
				fetch('./api/account-data').then(r => {
					if (r.status === 401) {
						window.location.reload();
						return Promise.reject('Unauthorized');
					}
					return r.json();
				}),
				fetch('./api/auto-sell').then(r => {
					if (r.status === 401) {
						window.location.reload();
						return Promise.reject('Unauthorized');
					}
					return r.json();
				})
			])
				.then(([accountResult, autoSellResult]) => {
					if (accountResult.status === 'success') {
						// Update headline with timestamp and status
						if (accountResult.timestamp) {
							const headlineTime = document.getElementById('headline-time');
							if (headlineTime) {
								let headlineText = 'Account ' + accountResult.timestamp;
								if (accountResult.current_status) {
									headlineText += ' (' + accountResult.current_status + ')';
								}
								headlineTime.textContent = headlineText;
							}
						}
						const data = accountResult.data || [];
						const tableContainer = document.getElementById('table-container');
						
						// Get auto sell status data
						const autoSellData = (autoSellResult.status === 'success' && autoSellResult.data) ? autoSellResult.data : {};
						
						// Group data by account on the frontend
						const accountGroups = {};
						for (const item of data) {
							const acctNo = item.account || '';
							if (!accountGroups[acctNo]) {
								accountGroups[acctNo] = [];
							}
							accountGroups[acctNo].push(item);
						}
						
						// Check if we have any data
						const hasData = Object.keys(accountGroups).length > 0 && 
							Object.values(accountGroups).some(stocks => stocks && stocks.length > 0);
						
						if (!hasData) {
							if (!tableContainer.querySelector('.empty-state')) {
								tableContainer.innerHTML = `
									<div class="empty-state">
										<h2>No Holdings Found</h2>
										<p>No account holdings are currently available.</p>
									</div>
								`;
							}
							return;
						}

						// Remove empty state if exists
						const emptyState = tableContainer.querySelector('.empty-state');
						if (emptyState) emptyState.remove();
						
						const sortedAccounts = Object.keys(accountGroups).sort();
						
						// 1. Remove accounts that no longer exist in data
						const existingGroups = tableContainer.querySelectorAll('.account-group');
						existingGroups.forEach(group => {
							const id = group.id.replace('account-group-', '');
							if (!accountGroups[id]) group.remove();
						});

						// 2. Update or Create accounts
						for (const acctNo of sortedAccounts) {
							let group = document.getElementById('account-group-' + acctNo);
							const stocks = accountGroups[acctNo] || [];
							
							// Get auto sell status
							let cleanMode = autoSellData[acctNo] || 'NONE';
							if (typeof cleanMode === 'boolean') cleanMode = cleanMode ? 'SELL' : 'NONE';
							if (!['NONE', 'BUY', 'SELL', 'BOTH'].includes(cleanMode)) cleanMode = 'NONE';
							
							// If group doesn't exist, create it
							if (!group) {
								group = document.createElement('div');
								group.className = 'account-group';
								group.id = 'account-group-' + acctNo;
								
								// Generate options
								const options = ['NONE', 'BUY', 'SELL', 'BOTH'].map(mode => 
									`<option value="${mode}" ${mode === cleanMode ? 'selected' : ''}>${mode}</option>`
								).join('');
								
								group.innerHTML = `
									<div class="account-group-header">
										<h2 class="account-header-text">Account: ${acctNo}</h2>
										<div class="auto-sell-control">
											<select id="select-auto-sell-${acctNo}" class="auto-sell-select">
												${options}
											</select>
											<button class="btn-apply-auto-sell" onclick="applyAccountAutoSell('${acctNo}')">Apply</button>
										</div>
									</div>
									<table>
										<thead>
											<tr>
												<th>Code</th>
												<th>Name</th>
												<th>Qty</th>
												<th>AVGCUR PRC</th>
												<th>Profit Rate</th>
												<th>PRESET PRC/RATE</th>
											</tr>
										</thead>
										<tbody></tbody>
									</table>
								`;
								// Insert in sorted order could be complex, assume appending is fine or handled by sort order if we clear. 
								// Since we update in order, appending is fine for new ones. 
								// To strictly maintain order for interleaved additions:
								// Find successor
								const successorId = sortedAccounts.find(a => a > acctNo && document.getElementById('account-group-' + a));
								if (successorId) {
									tableContainer.insertBefore(group, document.getElementById('account-group-' + successorId));
								} else {
									tableContainer.appendChild(group);
								}
							}
							
							// Update Select Box if not focused
							const selectBox = group.querySelector(`#select-auto-sell-${acctNo}`);
							if (selectBox && document.activeElement !== selectBox) {
								if (selectBox.value !== cleanMode) {
									selectBox.value = cleanMode;
								}
							}

							// Update Rows
							const tbody = group.querySelector('tbody');
							// Get existing rows, but exclude edit areas (they don't have data-row-id)
							const existingRows = Array.from(tbody.rows).filter(r => r.getAttribute('data-row-id') && !r.classList.contains('sell-price-edit-area'));
							const rowMap = new Map();
							existingRows.forEach(r => rowMap.set(r.getAttribute('data-row-id'), r));
							const processedIds = new Set();
							
							// Map to track edit areas: rowId -> editArea element
							const editAreaMap = new Map();
							existingRows.forEach(r => {
								const nextSibling = r.nextElementSibling;
								if (nextSibling && nextSibling.classList.contains('sell-price-edit-area')) {
									editAreaMap.set(r.getAttribute('data-row-id'), nextSibling);
								}
							});
							
							// Sort stocks ? Logic just iterates data order.
							
							for (const item of stocks) {
								const rowId = item.account + '_' + item.stock_code;
								processedIds.add(rowId);
								
								const profitClass = getProfitClass(item.profit_rate);
								const rmndQty = item.rmnd_qty || '0';
								const presetPrcRate = item.preset_prc_rate || '- / -';
								
								// Extract parts
								let sellPrice = '', sellRate = '';
								const parts = presetPrcRate.split(' / ');
								if (parts.length === 2) {
									sellPrice = parts[0].trim() !== '-' ? parts[0].trim().replace(/,/g, '') : '';
									sellRate = parts[1].trim() !== '-' ? parts[1].trim().replace('%', '') : '';
								}
								
								const cellContent = `
									<td><strong>${item.stock_code}</strong></td>
									<td>${item.stock_name}</td>
									<td>${item.tradeable_qty} / ${rmndQty}</td>
									<td>${item.avg_buy_price}</td>
									<td class="${profitClass}">${item.profit_rate}</td>
									<td>${presetPrcRate}</td>
								`;
								
								let row = rowMap.get(rowId);
								if (row) {
									// Check if there's an edit area after this row - preserve it
									const editArea = editAreaMap.get(rowId);
									
									// Update existing row if content changed
									// Instead of replacing innerHTML, update cells individually to preserve edit area
									const cells = row.querySelectorAll('td');
									if (cells.length >= 6) {
										// Update cells individually
										if (cells[0].innerHTML !== `<strong>${item.stock_code}</strong>`) cells[0].innerHTML = `<strong>${item.stock_code}</strong>`;
										if (cells[1].textContent !== item.stock_name) cells[1].textContent = item.stock_name;
										if (cells[2].textContent !== `${item.tradeable_qty} / ${rmndQty}`) cells[2].textContent = `${item.tradeable_qty} / ${rmndQty}`;
										if (cells[3].textContent !== item.avg_buy_price) cells[3].textContent = item.avg_buy_price;
										if (cells[4].className !== profitClass || cells[4].textContent !== item.profit_rate) {
											cells[4].className = profitClass;
											cells[4].textContent = item.profit_rate;
										}
										if (cells[5].textContent !== presetPrcRate) cells[5].textContent = presetPrcRate;
									} else {
										// Fallback: if cell count doesn't match, update innerHTML
										row.innerHTML = cellContent;
									}
									// Update attributes always to be safe or check them
									if (row.getAttribute('data-sell-price') !== sellPrice) row.setAttribute('data-sell-price', sellPrice);
									if (row.getAttribute('data-sell-rate') !== sellRate) row.setAttribute('data-sell-rate', sellRate);
									if (row.getAttribute('data-profit-rate') !== item.profit_rate) row.setAttribute('data-profit-rate', item.profit_rate); // if used elsewhere
									// Always set data-avg-buy-price to ensure it's present
									row.setAttribute('data-avg-buy-price', item.avg_buy_price || '');
									// onclick persists
									
									// Restore edit area if it existed
									if (editArea && editArea.parentNode !== tbody) {
										// Edit area was removed, re-insert it
										row.parentNode.insertBefore(editArea, row.nextSibling);
									} else if (editArea && editArea.nextElementSibling !== row && editArea.previousElementSibling !== row) {
										// Edit area exists but is in wrong position, move it
										editArea.remove();
										row.parentNode.insertBefore(editArea, row.nextSibling);
									}
								} else {
									// Create new row
									row = document.createElement('tr');
									row.setAttribute('data-row-id', rowId);
									row.setAttribute('data-stock-code', item.stock_code);
									row.setAttribute('data-stock-name', item.stock_name);
									row.setAttribute('data-sell-price', sellPrice);
									row.setAttribute('data-sell-rate', sellRate);
									row.setAttribute('data-avg-buy-price', item.avg_buy_price || '');
									row.setAttribute('onclick', 'selectRow(this)');
									row.innerHTML = cellContent;
									tbody.appendChild(row);
								}
							}
							
							// Remove Deleted Rows
							for (const [id, r] of rowMap) {
								if (!processedIds.has(id)) {
									// Also remove any edit area that follows this row
									const nextSibling = r.nextElementSibling;
									if (nextSibling && nextSibling.classList.contains('sell-price-edit-area')) {
										nextSibling.remove();
									}
									r.remove();
								}
							}
						}
					}
				})
				.catch(error => {
					console.error('Error updating table:', error);
					const tableContainer = document.getElementById('table-container');
					if (tableContainer) {
						tableContainer.innerHTML = `
							<div class="empty-state error-state" style="border: 2px solid #e74c3c; background-color: #fadbd8; padding: 20px; border-radius: 8px; text-align: center;">
								<h2 style="color: #c0392b; margin-bottom: 10px;">Backend is down. Retrying...</h2>
								<p style="color: #7f8c8d;">Connection to the server failed. Will try again automatically.</p>
							</div>
						`;
					}
				});
		}
		
		function loadAccountAutoSellStatus() {
			fetch('./api/auto-sell')
				.then(response => response.json())
				.then(result => {
					if (result.status === 'success' && result.data) {
						const autoSellData = result.data;
						// Update each account button
						for (const account in autoSellData) {
							updateAccountAutoSellSelect(account, autoSellData[account]);
						}
					}
				})
				.catch(error => {
					console.error('Error loading account auto sell status:', error);
				});
		}
		
		function updateAccountAutoSellSelect(account, mode) {
			const select = document.getElementById('select-auto-sell-' + account);
			if (select) {
				// Normalize mode
				const validModes = ['NONE', 'BUY', 'SELL', 'BOTH'];
				if (typeof mode === 'boolean') {
					mode = mode ? 'SELL' : 'NONE';
				}
				if (!validModes.includes(mode)) {
					mode = 'NONE';
				}
				select.value = mode;
			}
		}
		
		function applyAccountAutoSell(account) {
			const select = document.getElementById('select-auto-sell-' + account);
			if (!select) return;
			
			const selectedMode = select.value;
			
			fetch('./api/auto-sell', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ account: account, enabled: selectedMode })
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					updateAccountAutoSellSelect(account, result.enabled);
					showMessage(result.message || `Auto trade mode set to ${result.enabled} for account ${account}`, 'success');
				} else {
					showMessage('Error: ' + (result.message || 'Failed to update auto sell status'), 'error');
				}
			})
			.catch(error => {
				console.error('Error applying account auto sell:', error);
				showMessage('Error applying auto sell: ' + error.message, 'error');
			});
		}
		
		
		function logout() {
			fetch('./api/logout', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			})
			.then(response => response.json())
			.then(result => {
				// Clear cookie and redirect to login
				document.cookie = 'stoken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
				const currentPath = window.location.pathname;
				if (currentPath.includes('/stock')) {
					window.location.href = '/stock/login';
				} else {
					window.location.href = '/login';
				}
			})
			.catch(error => {
				console.error('Logout error:', error);
				// Still redirect even if API call fails
				document.cookie = 'stoken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
				const currentPath = window.location.pathname;
				if (currentPath.includes('/stock')) {
					window.location.href = '/stock/login';
				} else {
					window.location.href = '/login';
				}
			});
		}
		
		function logout() {
			fetch('./api/logout', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			})
			.then(response => response.json())
			.then(result => {
				// Clear cookie and redirect to login
				document.cookie = 'stoken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
				const currentPath = window.location.pathname;
				if (currentPath.includes('/stock')) {
					window.location.href = '/stock/login';
				} else {
					window.location.href = '/login';
				}
			})
			.catch(error => {
				console.error('Logout error:', error);
				// Still redirect even if API call fails
				document.cookie = 'stoken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
				const currentPath = window.location.pathname;
				if (currentPath.includes('/stock')) {
					window.location.href = '/stock/login';
				} else {
					window.location.href = '/login';
				}
			});
		}
		
		function showMessage(message, type) {
			// Simple alert for now since update-message div is removed
			alert(message);
		}
		
		function updateMiche() {
			fetch('./api/miche-data')
				.then(response => response.json())
				.then(result => {
					if (result.status === 'success') {
						const micheData = result.data || [];
						const micheContainer = document.getElementById('miche-container');
						const micheSection = document.getElementById('miche-section');
						
						// Collect all orders into a single list
						const allOrders = [];
						const micheValues = Array.isArray(micheData) ? micheData : Object.values(micheData);
						for (const item of micheValues) {
							const acctNo = item.ACCT || '';
							// Extract oso (unexecuted orders) from each account
							if (item.oso && Array.isArray(item.oso)) {
								for (const order of item.oso) {
									// Add ACCT to each order for cancellation
									const orderWithAcct = {
										...order,
										ACCT: acctNo
									};
									allOrders.push(orderWithAcct);
								}
							}
						}
						
						// Check if we have any data
						const hasData = allOrders.length > 0;
						
						// Always show miche section
						micheSection.style.display = 'block';
						
						// Build HTML for grouped miche orders
						let htmlContent = '';
						
						if (!hasData) {
							// Show table with headers but empty tbody
							htmlContent += `
								<div class="account-group">
									<div class="account-group-header">
										<h2>Orders</h2>
									</div>
									<table>
										<thead>
											<tr>
												<th>Account</th>
												<th>Code</th>
												<th>Name</th>
												<th>TYPE</th>
												<th>Order Qty</th>
												<th>Order / Current</th>
												<th>REMAIN</th>
												<th>Time</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
													No unexecuted orders available
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							`;
						} else {
							// Sort orders: Account -> Stock Code -> Order Type
							allOrders.sort((a, b) => {
								// Sort by Account
								const acctA = a.ACCT || '';
								const acctB = b.ACCT || '';
								if (acctA < acctB) return -1;
								if (acctA > acctB) return 1;
								
								// Sort by Stock Code
								const codeA = a.stk_cd || '';
								const codeB = b.stk_cd || '';
								// Remove 'A' for comparison if present
								const cleanCodeA = codeA.startsWith('A') ? codeA.substring(1) : codeA;
								const cleanCodeB = codeB.startsWith('A') ? codeB.substring(1) : codeB;
								if (cleanCodeA < cleanCodeB) return -1;
								if (cleanCodeA > cleanCodeB) return 1;
								
								// Sort by Order Type (Buy first, then Sell)
								const typeA = a.io_tp_nm || '';
								const typeB = b.io_tp_nm || '';
								if (typeA.includes('매수') && !typeB.includes('매수')) return -1;
								if (!typeA.includes('매수') && typeB.includes('매수')) return 1;
								return 0;
							});
							
							// Single table with one header
							htmlContent += `
								<div class="account-group">
									<div class="account-group-header">
										<h2>Orders</h2>
									</div>
									<table>
										<thead>
											<tr>
												<th>Account</th>
												<th>Code</th>
												<th>Name</th>
												<th>TYPE</th>
												<th>Order Qty</th>
												<th>Order / Current</th>
												<th>REMAIN</th>
												<th>Time</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
							`;
							
							for (const order of allOrders) {
								const stkCd = order.stk_cd || '';
								const stkCdClean = stkCd && stkCd[0] === 'A' ? stkCd.substring(1) : stkCd;
								let ordQty = 0;
								if (order.ord_qty) {
									const ordQtyStr = order.ord_qty.toString().replace(/^0+/, '') || '0';
									ordQty = parseInt(ordQtyStr) || 0;
									if (isNaN(ordQty)) ordQty = 0;
								}
								let osoQty = 0;
								if (order.oso_qty) {
									const osoQtyStr = order.oso_qty.toString().replace(/^0+/, '') || '0';
									osoQty = parseInt(osoQtyStr) || 0;
									if (isNaN(osoQty)) osoQty = 0;
								}
								// Parse ord_pric field - handle zero-padded strings
								let ordPric = 0;
								if (order.ord_pric) {
									const ordPricStr = order.ord_pric.toString().replace(/^0+/, '') || '0';
									ordPric = parseInt(ordPricStr) || 0;
									if (isNaN(ordPric)) ordPric = 0;
								}
								let curPrc = 0;
								if (order.cur_prc) {
									const curPrcStr = order.cur_prc.toString().replace(/^0+/, '') || '0';
									curPrc = parseInt(curPrcStr) || 0;
									if (isNaN(curPrc)) curPrc = 0;
								}
								const ordNo = order.ord_no || '';
								const stexTp = order.stex_tp || '0';
								
								// Format order price / current price
								let priceDisplay = '-';
								if (ordPric > 0 && curPrc > 0) {
									priceDisplay = ordPric.toLocaleString() + ' / ' + curPrc.toLocaleString();
								} else if (ordPric > 0) {
									priceDisplay = ordPric.toLocaleString() + ' / -';
								} else if (curPrc > 0) {
									priceDisplay = '- / ' + curPrc.toLocaleString();
								}
								
								htmlContent += `
									<tr class="miche-row" 
										data-stock-code="${stkCdClean}" 
										data-stock-name="${order.stk_nm || ''}" 
										data-order-price="${ordPric || ''}"
										data-current-price="${curPrc || ''}"
										onclick="selectMicheRow(this)"
										style="cursor: pointer;">
										<td class="account-cell">${order.ACCT}</td>
										<td><strong>${stkCdClean}</strong></td>
										<td>${order.stk_nm || '-'}</td>
										<td>${order.io_tp_nm || '-'}</td>
										<td>${ordQty > 0 ? ordQty.toLocaleString() : '0'}</td>
										<td>${priceDisplay}</td>
										<td><strong>${osoQty > 0 ? osoQty.toLocaleString() : '0'}</strong></td>
										<td>${order.tm || '-'}</td>
										<td>
											<button class="btn-cancel" 
												data-acct="${order.ACCT || ''}"
												data-stex-tp="${stexTp}"
												data-ord-no="${ordNo}"
												data-stk-cd="${stkCd}"
												onclick="event.stopPropagation(); cancelOrder(this)">
												Cancel
											</button>
										</td>
									</tr>
								`;
							}
							
							htmlContent += `
										</tbody>
									</table>
								</div>
							`;
						}
						
						micheContainer.innerHTML = htmlContent;
						// Update mobile display after table is rendered
						updateMobileDisplay();
					} else {
						// Show empty table even on API error
						const micheSection = document.getElementById('miche-section');
						const micheContainer = document.getElementById('miche-container');
						micheSection.style.display = 'block';
						micheContainer.innerHTML = `
							<div class="account-group">
								<div class="account-group-header">
									<h2>Orders</h2>
								</div>
								<table>
									<thead>
									<tr>
										<th>Account</th>
										<th>Code</th>
										<th>Name</th>
										<th>TYPE</th>
										<th>Order Qty</th>
										<th>Order / Current</th>
										<th>REMAIN</th>
										<th>Time</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
											Error loading unexecuted orders
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					`;
						// Update mobile display after error table is rendered
						updateMobileDisplay();
				}
			})
			.catch(error => {
				console.error('Error updating miche:', error);
				const micheSection = document.getElementById('miche-section');
				const micheContainer = document.getElementById('miche-container');
				micheSection.style.display = 'block';
				micheContainer.innerHTML = `
					<div class="account-group">
						<div class="account-group-header">
							<h2>Unexecuted Orders</h2>
						</div>
						<table>
							<thead>
								<tr>
									<th>Account</th>
									<th>Code</th>
									<th>Name</th>
									<th>TYPE</th>
									<th>Order Qty</th>
									<th>Order / Current</th>
									<th>REMAIN</th>
									<th>Time</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
										Error loading unexecuted orders
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				`;
				// Update mobile display after error table is rendered
				updateMobileDisplay();
			});
		}
		
		function cancelOrder(buttonElement) {
			const acct = buttonElement.getAttribute('data-acct');
			const stexTp = buttonElement.getAttribute('data-stex-tp');
			const ordNo = buttonElement.getAttribute('data-ord-no');
			const stkCd = buttonElement.getAttribute('data-stk-cd');
			
			if (!acct || !ordNo || !stkCd) {
				alert('Missing required information to cancel order');
				return;
			}
			
			if (!confirm('Are you sure you want to cancel this order?')) {
				return;
			}
			
			// Disable button during request
			buttonElement.disabled = true;
			buttonElement.textContent = 'Cancelling...';
			
			fetch('./api/cancel-order', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					acct: acct,
					stex: stexTp,
					ord_no: ordNo,
					stk_cd: stkCd
				})
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					// Refresh miche data after a short delay
					setTimeout(updateMiche, 1000);
				} else {
					alert('Error cancelling order: ' + (result.message || 'Unknown error'));
					buttonElement.disabled = false;
					buttonElement.textContent = 'Cancel';
				}
			})
			.catch(error => {
				console.error('Error cancelling order:', error);
				alert('Error cancelling order: ' + error.message);
				buttonElement.disabled = false;
				buttonElement.textContent = 'Cancel';
			});
		}
		
		
		function updateSellPrices() {
			// Function disabled - All Sell Prices & Rates section removed
			return;
			// Add cache-busting parameter to ensure fresh data
			const timestamp = new Date().getTime();
			fetch('./api/sell-prices?t=' + timestamp)
				.then(response => response.json())
				.then(result => {
					if (result.status === 'success') {
						const sellPricesData = result.data || {};
						const sellPricesContainer = document.getElementById('sell-prices-container');
						const sellPricesSection = document.getElementById('sell-prices-section');
						
						// Always show sell prices section
						sellPricesSection.style.display = 'block';
						
						// Get all stock codes and filter out entries without price/rate
						const allStockCodes = Object.keys(sellPricesData).sort();
						const validStockCodes = [];
						
						for (const stockCode of allStockCodes) {
							const sellCond = sellPricesData[stockCode];
							// Only include entries that have price or rate
							if (sellCond.price || (sellCond.rate !== undefined && sellCond.rate !== null)) {
								validStockCodes.push(stockCode);
							}
						}
						
						if (validStockCodes.length === 0) {
							sellPricesContainer.innerHTML = `
								<div class="account-group">
									<div class="account-group-header">
										<h2>Sell Prices & Rates</h2>
									</div>
									<table>
										<thead>
											<tr>
												<th>Code</th>
												<th>Name</th>
												<th>Sell Price</th>
												<th>Sell Rate</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">
													No sell prices/rates configured
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							`;
							return;
						}
						
						let htmlContent = `
							<div class="account-group">
								<div class="account-group-header">
									<h2>Sell Prices & Rates</h2>
								</div>
								<table>
									<thead>
										<tr>
											<th>Code</th>
											<th>Name</th>
											<th>Sell Price</th>
											<th>Sell Rate</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
						`;
						
						for (const stockCode of validStockCodes) {
							const sellCond = sellPricesData[stockCode];
							
							const stockName = sellCond.stock_name || '-';
							
							let sellPrice = '-';
							if (sellCond.price) {
								try {
									const priceNum = parseFloat(sellCond.price);
									if (!isNaN(priceNum) && priceNum > 0) {
										sellPrice = priceNum.toLocaleString();
									}
								} catch (e) {
									sellPrice = sellCond.price;
								}
							}
							
							let sellRate = '-';
							if (sellCond.rate !== undefined && sellCond.rate !== null) {
								try {
									sellRate = (parseFloat(sellCond.rate) * 100).toFixed(2) + '%';
								} catch (e) {
									sellRate = '-';
								}
							}
							
							htmlContent += `
								<tr data-stock-code="${stockCode}" data-stock-name="${stockName}" data-sell-price="${sellCond.price || ''}" data-sell-rate="${sellCond.rate || ''}" onclick="selectSellPriceRow(this)">
									<td><strong>${stockCode}</strong></td>
									<td>${stockName}</td>
									<td>${sellPrice}</td>
									<td>${sellRate}</td>
									<td>
										<button class="btn-delete-row" onclick="event.stopPropagation(); deleteRowSellPrice('${stockCode}', '${stockName}')" title="Delete sell price/rate">
											Del️
										</button>
									</td>
								</tr>
							`;
						}
						
						htmlContent += `
									</tbody>
								</table>
							</div>
						`;
						
						sellPricesContainer.innerHTML = htmlContent;
					} else {
						// Show error state
						const sellPricesContainer = document.getElementById('sell-prices-container');
						const sellPricesSection = document.getElementById('sell-prices-section');
						sellPricesSection.style.display = 'block';
						sellPricesContainer.innerHTML = `
							<div class="account-group">
								<div class="account-group-header">
									<h2>Sell Prices & Rates</h2>
								</div>
								<table>
									<thead>
										<tr>
											<th>Code</th>
											<th>Name</th>
											<th>Sell Price</th>
											<th>Sell Rate</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">
												Error loading sell prices/rates
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						`;
					}
				})
				.catch(error => {
					console.error('Error updating sell prices:', error);
					const sellPricesContainer = document.getElementById('sell-prices-container');
					const sellPricesSection = document.getElementById('sell-prices-section');
					sellPricesSection.style.display = 'block';
					sellPricesContainer.innerHTML = `
						<div class="account-group">
							<div class="account-group-header">
								<h2>Sell Prices & Rates</h2>
							</div>
							<table>
								<thead>
									<tr>
										<th>Code</th>
										<th>Name</th>
										<th>Sell Price</th>
										<th>Sell Rate</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">
											Error loading sell prices/rates
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					`;
				});
		}
		
		function selectSellPriceRow(rowElement) {
			// Remove selected class from all rows
			document.querySelectorAll('#sell-prices-container tbody tr').forEach(tr => {
				tr.classList.remove('selected');
			});

			// Add selected class to clicked row
			rowElement.classList.add('selected');

			// Get stock code, stock name, sell price, and sell rate from row
			const stockCode = rowElement.getAttribute('data-stock-code');
			const stockName = rowElement.getAttribute('data-stock-name') || '';
			const sellPrice = rowElement.getAttribute('data-sell-price') || '';
			const sellRate = rowElement.getAttribute('data-sell-rate') || '';

			// Fill buy section
			document.getElementById('buy-stock-code-input').value = stockCode;
			document.getElementById('buy-stock-name-input').value = stockName;
			document.getElementById('buy-price-input').value = '';
			document.getElementById('buy-amount-input').value = '';

			// Fill int stocks section
			document.getElementById('interested-stock-code-input').value = stockCode;
			document.getElementById('interested-stock-name-input').value = stockName;
			if (sellPrice && sellPrice !== '-') {
				const priceValue = sellPrice.replace(/,/g, '');
				document.getElementById('interested-stock-price-input').value = priceValue;
			} else {
				document.getElementById('interested-stock-price-input').value = '';
			}
			if (sellRate && sellRate !== '-') {
				// Extract percentage value from "5.5%" format or use as-is
				const rateMatch = sellRate.match(/([\d.+-]+)%/);
				if (rateMatch) {
					// Store percentage as-is (no conversion)
					document.getElementById('interested-stock-rate-input').value = rateMatch[1];
				} else {
					// Use as-is (no conversion)
					document.getElementById('interested-stock-rate-input').value = sellRate;
				}
			} else {
				document.getElementById('interested-stock-rate-input').value = '';
			}
			document.getElementById('interested-stock-gaprate-input').value = '';
			
			// Scroll to update section
			
			// Show/hide input area for editing sell price/rate/sellgap
			// Remove any existing edit areas
			document.querySelectorAll('.sell-price-edit-area').forEach(area => {
				area.remove();
			});
			
			// Check if edit area already exists for this row
			const existingEditArea = rowElement.nextElementSibling;
			if (existingEditArea && existingEditArea.classList.contains('sell-price-edit-area')) {
				// Toggle: if already showing, hide it
				existingEditArea.remove();
			} else {
				// Create new edit area
				const editArea = document.createElement('tr');
				editArea.className = 'sell-price-edit-area show';
				
				// Get sellgap, sellrate, and bamount from interested_stocks if available
				let sellgap = '';
				let sellrateFromAPI = '';
				let bamount = '';
				fetch('./api/interested-stocks?t=' + Date.now())
					.then(response => response.json())
					.then(result => {
						if (result.status === 'success' && result.data && result.data[stockCode]) {
							sellgap = result.data[stockCode].sellgap || '';
							sellrateFromAPI = result.data[stockCode].sellrate || '';
							bamount = result.data[stockCode].bamount || '';
						}
						
						// Use sellrate from API if available, otherwise use from row attribute
						const finalSellRate = sellrateFromAPI || sellRate || '';
						
						// Create edit form
						editArea.innerHTML = `
							<td colspan="7">
								<div class="sell-price-edit-form">
									<div>
										<label>Sell Price:</label>
										<input type="number" id="edit-sell-price-${stockCode}" placeholder="Price" step="0.01" value="${sellPrice || ''}">
									</div>
									<div>
										<label>Sell Rate (%):</label>
										<input type="number" id="edit-sell-rate-${stockCode}" placeholder="Rate" step="0.01" value="${finalSellRate || ''}">
									</div>
									<div>
										<label>Sell Gap:</label>
										<input type="number" id="edit-sell-gap-${stockCode}" placeholder="Gap" step="0.01" value="${sellgap || ''}">
									</div>
									<div>
										<label>BAmount:</label>
										<input type="number" id="edit-bamount-${stockCode}" placeholder="BAmount" step="1" value="${bamount || ''}">
									</div>
									<div class="sell-price-edit-buttons">
										<button class="btn-apply-sell-price" onclick="applySellPriceEdit('${stockCode}', '${stockName}')">Apply</button>
										<button class="btn-cancel-sell-price" onclick="cancelSellPriceEdit('${stockCode}')">Cancel</button>
									</div>
								</div>
							</td>
						`;
						
						// Insert after the clicked row
						rowElement.parentNode.insertBefore(editArea, rowElement.nextSibling);
						
						// Add select-all on click for input fields
						const priceInput = document.getElementById(`edit-sell-price-${stockCode}`);
						const rateInput = document.getElementById(`edit-sell-rate-${stockCode}`);
						const gapInput = document.getElementById(`edit-sell-gap-${stockCode}`);
						const bamountInput = document.getElementById(`edit-bamount-${stockCode}`);
						
						if (priceInput) {
							priceInput.addEventListener('click', function() { this.select(); });
							priceInput.addEventListener('focus', function() { this.select(); });
						}
						if (rateInput) {
							rateInput.addEventListener('click', function() { this.select(); });
							rateInput.addEventListener('focus', function() { this.select(); });
						}
						if (gapInput) {
							gapInput.addEventListener('click', function() { this.select(); });
							gapInput.addEventListener('focus', function() { this.select(); });
						}
						if (bamountInput) {
							bamountInput.addEventListener('click', function() { this.select(); });
							bamountInput.addEventListener('focus', function() { this.select(); });
						}
					})
					.catch(error => {
						console.error('Error fetching sellgap and sellrate:', error);
						// Still create edit area without sellgap and sellrate from API
						// Use sellRate from row attribute as fallback
						editArea.innerHTML = `
							<td colspan="7">
								<div class="sell-price-edit-form">
									<div>
										<label>Sell Price:</label>
										<input type="number" id="edit-sell-price-${stockCode}" placeholder="Price" step="0.01" value="${sellPrice || ''}">
									</div>
									<div>
										<label>Sell Rate (%):</label>
										<input type="number" id="edit-sell-rate-${stockCode}" placeholder="Rate" step="0.01" value="${sellRate || ''}">
									</div>
									<div>
										<label>Sell Gap:</label>
										<input type="number" id="edit-sell-gap-${stockCode}" placeholder="Gap" step="0.01" value="">
									</div>
									<div>
										<label>BAmount:</label>
										<input type="number" id="edit-bamount-${stockCode}" placeholder="BAmount" step="1" value="">
									</div>
									<div class="sell-price-edit-buttons">
										<button class="btn-apply-sell-price" onclick="applySellPriceEdit('${stockCode}', '${stockName}')">Apply</button>
										<button class="btn-cancel-sell-price" onclick="cancelSellPriceEdit('${stockCode}')">Cancel</button>
									</div>
								</div>
							</td>
						`;
						rowElement.parentNode.insertBefore(editArea, rowElement.nextSibling);
						
						// Add select-all on click for input fields
						const priceInput = document.getElementById(`edit-sell-price-${stockCode}`);
						const rateInput = document.getElementById(`edit-sell-rate-${stockCode}`);
						const gapInput = document.getElementById(`edit-sell-gap-${stockCode}`);
						const bamountInput = document.getElementById(`edit-bamount-${stockCode}`);
						
						if (priceInput) {
							priceInput.addEventListener('click', function() { this.select(); });
							priceInput.addEventListener('focus', function() { this.select(); });
						}
						if (rateInput) {
							rateInput.addEventListener('click', function() { this.select(); });
							rateInput.addEventListener('focus', function() { this.select(); });
						}
						if (gapInput) {
							gapInput.addEventListener('click', function() { this.select(); });
							gapInput.addEventListener('focus', function() { this.select(); });
						}
						if (bamountInput) {
							bamountInput.addEventListener('click', function() { this.select(); });
							bamountInput.addEventListener('focus', function() { this.select(); });
						}
					});
			}
		}
		
		function updateInterestedStocks() {
			const timestamp = new Date().getTime();
			fetch('./api/interested-stocks?t=' + timestamp)
				.then(response => response.json())
				.then(result => {
					if (result.status === 'success') {
						const interestedStocksData = result.data || {};
						const interestedStocksContainer = document.getElementById('interested-stocks-container');
						const interestedStocksSection = document.getElementById('interested-stocks-section');
						
						// Always show interested stocks section
						interestedStocksSection.style.display = 'block';
						
						// Get all stock codes
						const stockCodes = Object.keys(interestedStocksData).sort();
						
						if (stockCodes.length === 0) {
							interestedStocksContainer.innerHTML = `
								<div class="account-group">
									<table>
										<thead>
											<tr>
												<th>Code</th>
												<th>Name</th>
												<th>COLOR</th>
												<th>BType</th>
												<th>BAmount</th>
												<th>PRICE</th>
												<th>RATE</th>
												<th>GAP</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
													No interested stocks added yet
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							`;
							return;
						}
						
						let htmlContent = `
							<div class="account-group">
								<table>
									<thead>
										<tr>
											<th>Code</th>
											<th>Name</th>
											<th>COLOR</th>
											<th>BType</th>
											<th>BAmount</th>
											<th>PRICE</th>
											<th>RATE</th>
											<th>GAP</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
						`;
						
						// Color mapping: R=빨, O=주, Y=노, G=초, B=파, D=남, V=보
						const colorMap = {
							'R': '빨',
							'O': '주',
							'Y': '노',
							'G': '초',
							'B': '파',
							'D': '남',
							'V': '보'
						};
						
						for (const stockCode of stockCodes) {
							const stockInfo = interestedStocksData[stockCode];
							const stockName = stockInfo.stock_name || '-';
							const stockColor = stockInfo.color || '';
							const stockBtype = stockInfo.btype || '';
							const stockBamount = stockInfo.bamount || '';
							const stockPrice = stockInfo.sellprice || '0';
							const stockRate = stockInfo.sellrate || '0';
							const stockGaprate = stockInfo.sellgap || '0';
							const colorDisplay = stockColor && colorMap[stockColor] ? colorMap[stockColor] : '-';
							
							// Format values for display
							let priceDisplay = '-';
							if (stockPrice && stockPrice !== '0') {
								const priceNum = parseFloat(stockPrice);
								if (!isNaN(priceNum) && priceNum > 0) {
									priceDisplay = priceNum.toLocaleString();
								}
							}
							// Display sellrate as-is from backend (no conversion)
							const rateDisplay = stockRate && stockRate !== '0' ? stockRate : '-';
							let gaprateDisplay = '-';
							if (stockGaprate && stockGaprate !== '0') {
								const gaprateNum = parseFloat(stockGaprate);
								if (!isNaN(gaprateNum) && gaprateNum !== 0) {
									gaprateDisplay = gaprateNum.toLocaleString();
								}
							}
							
							htmlContent += `
								<tr data-stock-code="${stockCode}" data-stock-name="${stockName}" data-stock-color="${stockColor}" data-stock-btype="${stockBtype}" data-stock-bamount="${stockBamount}" data-stock-price="${stockPrice}" data-stock-rate="${stockRate}" data-stock-gaprate="${stockGaprate}" onclick="selectInterestedStockRow(this)">
									<td><strong>${stockCode}</strong></td>
									<td>${stockName}</td>
									<td>${colorDisplay}</td>
									<td>${stockBtype || '-'}</td>
									<td>${stockBamount || '-'}</td>
									<td>${priceDisplay}</td>
									<td>${rateDisplay}</td>
									<td>${gaprateDisplay}</td>
									<td>
										<button class="btn-remove-interested" onclick="event.stopPropagation(); removeInterestedStock('${stockCode}', '${stockName}')" title="Remove from interested list">
											Remove
										</button>
									</td>
								</tr>
							`;
						}
						
						htmlContent += `
									</tbody>
								</table>
							</div>
						`;
						
						interestedStocksContainer.innerHTML = htmlContent;
					} else {
						// Show error state
						const interestedStocksContainer = document.getElementById('interested-stocks-container');
						const interestedStocksSection = document.getElementById('interested-stocks-section');
						interestedStocksSection.style.display = 'block';
						interestedStocksContainer.innerHTML = `
							<div class="account-group">
								<table>
									<thead>
										<tr>
											<th>Code</th>
											<th>Name</th>
											<th>COLOR</th>
											<th>BType</th>
											<th>BAmount</th>
											<th>PRICE</th>
											<th>RATE</th>
											<th>GAP</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
												Error loading interested stocks
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						`;
					}
				})
				.catch(error => {
					console.error('Error updating interested stocks:', error);
					const interestedStocksContainer = document.getElementById('interested-stocks-container');
					const interestedStocksSection = document.getElementById('interested-stocks-section');
					interestedStocksSection.style.display = 'block';
					interestedStocksContainer.innerHTML = `
						<div class="account-group">
							<table>
								<thead>
									<tr>
										<th>Code</th>
										<th>Name</th>
										<th>COLOR</th>
										<th>BType</th>
										<th>BAmount</th>
										<th>PRICE</th>
										<th>RATE</th>
										<th>GAP</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
											Error loading interested stocks
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					`;
				});
		}
		
		function addInterestedStock() {
			const stockCode = document.getElementById('interested-stock-code-input').value.trim();
			const stockName = document.getElementById('interested-stock-name-input').value.trim();
			const stockColor = document.getElementById('interested-stock-color-input').value.trim();
			const stockBtype = document.getElementById('interested-stock-btype-input').value.trim();
			const stockBamount = document.getElementById('interested-stock-bamount-input').value.trim();
			const stockPrice = document.getElementById('interested-stock-price-input').value.trim();
			const stockRate = document.getElementById('interested-stock-rate-input').value.trim();
			const stockGaprate = document.getElementById('interested-stock-gaprate-input').value.trim();
			
			if (!stockCode) {
				showMessage('Please enter a stock code', 'error');
				return;
			}
			
			// Store sellrate as decimal (user enters decimal, store as-is)
			const data = {
				stock_code: stockCode,
				stock_name: stockName || null,
				color: stockColor || null,
				btype: stockBtype || null,
				bamount: stockBamount ? parseInt(stockBamount) : null,
				sellprice: stockPrice || '0',
				sellrate: stockRate || '0',
				sellgap: stockGaprate || '0'
			};
			
			fetch('./api/interested-stocks', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					showMessage('Stock added/updated in interested list successfully!', 'success');
					document.getElementById('interested-stock-code-input').value = '';
					document.getElementById('interested-stock-name-input').value = '';
					document.getElementById('interested-stock-color-input').value = '';
					document.getElementById('interested-stock-btype-input').value = '';
					document.getElementById('interested-stock-bamount-input').value = '';
					document.getElementById('interested-stock-price-input').value = '';
					document.getElementById('interested-stock-rate-input').value = '';
					document.getElementById('interested-stock-gaprate-input').value = '';
					// Update immediately
					updateInterestedStocks();
				} else {
					showMessage('Error: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error adding stock: ' + error, 'error');
			});
		}
		
		function deleteInterestedStockFromForm() {
			const stockCode = document.getElementById('interested-stock-code-input').value.trim();
			const stockName = document.getElementById('interested-stock-name-input').value.trim();
			
			if (!stockCode) {
				showMessage('Please enter a stock code', 'error');
				return;
			}
			
			removeInterestedStock(stockCode, stockName);
		}
		
		function updateInterestedStockColor(stockCode, color) {
			if (!stockCode) {
				return;
			}
			
			const row = document.querySelector(`tr[data-stock-code="${stockCode}"]`);
			const stockName = row?.getAttribute('data-stock-name') || '';
			const stockBtype = row?.getAttribute('data-stock-btype') || '';
			const stockBamount = row?.getAttribute('data-stock-bamount') || '';
			
			const data = {
				stock_code: stockCode,
				stock_name: stockName || null,
				color: color || null,
				btype: stockBtype || null,
				bamount: stockBamount ? parseInt(stockBamount) : null
			};
			
			fetch('./api/interested-stocks', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					// Update immediately
					updateInterestedStocks();
				} else {
					showMessage('Error updating color: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error updating color: ' + error, 'error');
			});
		}
		
		function removeInterestedStock(stockCode, stockName) {
			if (!stockCode) {
				showMessage('Stock code is missing', 'error');
				return;
			}
			
			if (!confirm(`Remove ${stockName || stockCode} from interested list?`)) {
				return;
			}
			
			fetch('./api/interested-stocks/' + encodeURIComponent(stockCode), {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
				}
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					showMessage('Stock removed from interested list successfully!', 'success');
					// Update immediately
					updateInterestedStocks();
				} else {
					showMessage('Error: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error removing stock: ' + error, 'error');
			});
		}
		
		function selectInterestedStockRow(rowElement) {
			// Remove selected class from all rows
			document.querySelectorAll('#interested-stocks-container tbody tr').forEach(tr => {
				tr.classList.remove('selected');
			});
			
			// Add selected class to clicked row
			rowElement.classList.add('selected');
			
			// Get stock code, name, color, btype, and bamount from row
			const stockCode = rowElement.getAttribute('data-stock-code');
			const stockName = rowElement.getAttribute('data-stock-name') || '';
			const stockColor = rowElement.getAttribute('data-stock-color') || '';
			const stockBtype = rowElement.getAttribute('data-stock-btype') || '';
			const stockBamount = rowElement.getAttribute('data-stock-bamount') || '';
			const stockPrice = rowElement.getAttribute('data-stock-price') || '';
			const stockRate = rowElement.getAttribute('data-stock-rate') || '';
			const stockGaprate = rowElement.getAttribute('data-stock-gaprate') || '';
			
			// Fill the interested stocks form fields
			document.getElementById('interested-stock-code-input').value = stockCode;
			document.getElementById('interested-stock-name-input').value = stockName;
			document.getElementById('interested-stock-color-input').value = stockColor;
			document.getElementById('interested-stock-btype-input').value = stockBtype;
			document.getElementById('interested-stock-bamount-input').value = stockBamount;
			document.getElementById('interested-stock-price-input').value = stockPrice !== '0' ? stockPrice : '';
			// Display sellrate as-is from backend (no conversion)
			document.getElementById('interested-stock-rate-input').value = stockRate && stockRate !== '0' ? stockRate : '';
			document.getElementById('interested-stock-gaprate-input').value = stockGaprate !== '0' ? stockGaprate : '';
			
			// Fill buy section
			document.getElementById('buy-stock-code-input').value = stockCode;
			document.getElementById('buy-stock-name-input').value = stockName;
			document.getElementById('buy-price-input').value = '';
			document.getElementById('buy-amount-input').value = '';
			
			// Scroll to interested stocks section
			document.getElementById('interested-stocks-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
			
			// Show dialog if btype is 'CL'
			if (stockBtype === 'CL') {
				showStockPriceDialog(stockCode, stockName);
			}
		}
		
		function updateInterestedStockBtype(stockCode, btype) {
			if (!stockCode) {
				return;
			}
			
			const row = document.querySelector(`tr[data-stock-code="${stockCode}"]`);
			const stockName = row?.getAttribute('data-stock-name') || '';
			const stockColor = row?.getAttribute('data-stock-color') || '';
			const stockBamount = row?.getAttribute('data-stock-bamount') || '';
			
			const data = {
				stock_code: stockCode,
				stock_name: stockName || null,
				color: stockColor || null,
				btype: btype || null,
				bamount: stockBamount ? parseInt(stockBamount) : null
			};
			
			fetch('./api/interested-stocks', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					// Update immediately
					updateInterestedStocks();
				} else {
					showMessage('Error updating btype: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error updating btype: ' + error, 'error');
			});
		}
		
		function buyStock() {
			const stockCode = document.getElementById('buy-stock-code-input').value.trim();
			const stockName = document.getElementById('buy-stock-name-input').value.trim();
			const price = document.getElementById('buy-price-input').value.trim();
			const amount = document.getElementById('buy-amount-input').value.trim();
			
			if (!stockCode) {
				showMessage('Please enter a stock code', 'error');
				return;
			}
			
			if (!amount || amount === '' || parseInt(amount) <= 0) {
				showMessage('Please enter a valid amount', 'error');
				return;
			}
			
			if (!price || price === '' || parseFloat(price) <= 0) {
				showMessage('Please enter a valid price', 'error');
				return;
			}
			
			// Get account list from checkboxes
			const accountCheckboxes = document.querySelectorAll('#buy-account-checkboxes input[type="checkbox"]:checked');
			const accountList = Array.from(accountCheckboxes).map(cb => cb.value);
			
			// Validate that at least one account is selected
			if (accountList.length === 0) {
				showMessage('Please select at least one account', 'error');
				return;
			}
			
			// Call buy order API
			const buyData = {
				stock_code: stockCode,
				stock_name: stockName,
				price: price,
				amount: amount,
				accounts: accountList
			};
			
			fetch('./api/buy-order', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(buyData)
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					showMessage(result.message || `Buy order placed: ${amount} shares of ${stockName || stockCode} at ${price}`, 'success');
					// Clear the inputs after successful buy
					document.getElementById('buy-price-input').value = '';
					document.getElementById('buy-amount-input').value = '';
					// Uncheck all account checkboxes
					document.querySelectorAll('#buy-account-checkboxes input[type="checkbox"]').forEach(cb => {
						cb.checked = false;
					});
				} else if (result.status === 'partial') {
					showMessage(result.message || 'Some buy orders failed. Check details.', 'error');
				} else {
					showMessage('Error: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error placing buy order: ' + error, 'error');
			});
		}
		
		function updateInterestedStockBamount(stockCode, bamount) {
			if (!stockCode) {
				return;
			}
			
			const row = document.querySelector(`tr[data-stock-code="${stockCode}"]`);
			const stockName = row?.getAttribute('data-stock-name') || '';
			const stockColor = row?.getAttribute('data-stock-color') || '';
			const stockBtype = row?.getAttribute('data-stock-btype') || '';
			
			const data = {
				stock_code: stockCode,
				stock_name: stockName || null,
				color: stockColor || null,
				btype: stockBtype || null,
				bamount: bamount ? parseInt(bamount) : null
			};
			
			fetch('./api/interested-stocks', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					// Update immediately
					updateInterestedStocks();
				} else {
					showMessage('Error updating bamount: ' + result.message, 'error');
				}
			})
			.catch(error => {
				showMessage('Error updating bamount: ' + error, 'error');
			});
		}
		
		function loadAccountCheckboxes() {
			fetch('./api/accounts')
				.then(response => response.json())
				.then(result => {
					if (result.status === 'success' && result.data) {
						const checkboxesContainer = document.getElementById('buy-account-checkboxes');
						checkboxesContainer.innerHTML = '';
						
						result.data.forEach(account => {
							const label = document.createElement('label');
							label.style.display = 'flex';
							label.style.alignItems = 'center';
							label.style.gap = '5px';
							label.style.cursor = 'pointer';
							label.style.marginRight = '10px';
							
							const checkbox = document.createElement('input');
							checkbox.type = 'checkbox';
							checkbox.value = account;
							checkbox.id = 'buy-account-checkbox-' + account;
							checkbox.style.width = '16px';
							checkbox.style.height = '16px';
							checkbox.style.cursor = 'pointer';
							
							const span = document.createElement('span');
							span.textContent = account;
							span.style.fontSize = '14px';
							
							label.appendChild(checkbox);
							label.appendChild(span);
							checkboxesContainer.appendChild(label);
						});
					}
				})
				.catch(error => {
					console.error('Error loading accounts:', error);
				});
		}
		
		// Function to update mobile display (change "Account" to "ACCT")
		// Cache the mobile state to avoid unnecessary updates
		let cachedIsMobile = null;
		
		function updateMobileDisplay() {
			// Check if mobile (touch device AND screen width <= 1600px)
			// Only consider it mobile if BOTH conditions are true to avoid flickering on PC
			const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
			const isNarrowScreen = window.innerWidth <= 1600;
			const isMobile = hasTouch && isNarrowScreen;
			
			// Only update if state changed to avoid flickering
			if (cachedIsMobile === isMobile) {
				// Even if state hasn't changed, ensure text is correct after table recreation
				// Only update if text is actually wrong to prevent unnecessary DOM manipulation
				if (isMobile) {
					// On mobile, ensure "ACCNT:" is shown in account group headers (table might have been recreated)
					document.querySelectorAll('.account-header-text').forEach(h2 => {
						const text = h2.textContent;
						if (text && (text.startsWith('Account: ') || text.startsWith('ACCT: '))) {
							const acctNo = text.replace(/^(Account|ACCT): /, '');
							h2.textContent = 'ACCNT: ' + acctNo;
						}
					});
					// On mobile, ensure "ACCT" is shown (table might have been recreated)
					document.querySelectorAll('#miche-container table thead th:first-child').forEach(th => {
						const currentText = th.textContent.trim();
						if (currentText === 'Account') {
							th.textContent = 'ACCT';
						}
					});
					// On mobile, ensure "QTY" is shown (table might have been recreated)
					document.querySelectorAll('#miche-container table thead th:nth-child(5)').forEach(th => {
						const currentText = th.textContent.trim().toUpperCase();
						if (currentText === 'ORDER QTY' || (currentText !== 'QTY' && currentText.includes('ORDER'))) {
							th.textContent = 'QTY';
							th.style.textTransform = 'none';
						}
					});
				} else {
					// On PC, ensure "Account" is shown (table might have been recreated)
					document.querySelectorAll('#miche-container table thead th:first-child').forEach(th => {
						const currentText = th.textContent.trim();
						if (currentText === 'ACCT') {
							th.textContent = 'Account';
						}
					});
					// On PC, ensure "Order Qty" is shown (table might have been recreated)
					document.querySelectorAll('#miche-container table thead th:nth-child(5)').forEach(th => {
						const currentText = th.textContent.trim();
						if (currentText === 'QTY') {
							th.textContent = 'Order Qty';
							th.style.textTransform = '';
						}
					});
				}
				return;
			}
			cachedIsMobile = isMobile;
			
			if (isMobile) {
				// Change "Account:" to "ACCNT:" in account group headers
				document.querySelectorAll('.account-header-text').forEach(h2 => {
					const text = h2.textContent;
					if (text && text.startsWith('Account: ')) {
						const acctNo = text.replace('Account: ', '');
						h2.textContent = 'ACCNT: ' + acctNo;
					} else if (text && text.startsWith('ACCT: ')) {
						// Also handle if it's already "ACCT:" and needs to be changed to "ACCNT:"
						const acctNo = text.replace('ACCT: ', '');
						h2.textContent = 'ACCNT: ' + acctNo;
					}
				});
				
				// Change "Account" header to "ACCT" in miche table
				document.querySelectorAll('#miche-container table thead th:first-child').forEach(th => {
					if (th.textContent.trim() === 'Account') {
						th.textContent = 'ACCT';
					}
				});
				
				// Change "Order Qty" to "QTY" in orders section (5th column)
				document.querySelectorAll('#miche-container table thead th:nth-child(5)').forEach(th => {
					const text = th.textContent.trim().toUpperCase();
					if (text === 'ORDER QTY') {
						th.textContent = 'QTY';
						th.style.textTransform = 'none';
					}
				});
			} else {
				// Restore "Account:" in desktop
				document.querySelectorAll('.account-header-text').forEach(h2 => {
					const text = h2.textContent;
					if (text && (text.startsWith('ACCT: ') || text.startsWith('ACCNT: '))) {
						const acctNo = text.replace(/^(ACCT|ACCNT): /, '');
						h2.textContent = 'Account: ' + acctNo;
					}
				});
				
				// Restore "Account" header in desktop
				document.querySelectorAll('#miche-container table thead th:first-child').forEach(th => {
					if (th.textContent.trim() === 'ACCT') {
						th.textContent = 'Account';
					}
				});
				
				// Restore "Order Qty" in desktop
				document.querySelectorAll('#miche-container table thead th:nth-child(5)').forEach(th => {
					if (th.textContent.trim() === 'QTY') {
						th.textContent = 'Order Qty';
						th.style.textTransform = '';
					}
				});
			}
		}
		
		// Call updateMobileDisplay on window resize
		window.addEventListener('resize', updateMobileDisplay);
		
		// Auto-update every 1 second
		setInterval(function() {
			updateTable();
			updateMiche();
			updateSellPrices();
			updateInterestedStocks();
			// Note: updateMobileDisplay() is called inside updateMiche() after table is rendered
		}, 1000);
		
		// Initial update after page load
		updateTable();
		updateMiche();
		updateSellPrices();
		updateInterestedStocks();
		loadAccountCheckboxes();
		// Update mobile display after initial load
		setTimeout(updateMobileDisplay, 500);
		
		function showStockPriceDialog(stockCode, stockName) {
			const dialog = document.getElementById('stock-price-dialog');
			const dialogTitle = document.getElementById('stock-price-dialog-title');
			const dialogBody = document.getElementById('stock-price-dialog-body');
			
			// Set title
			dialogTitle.textContent = `${stockName} (${stockCode}) - Price Information`;
			
			// Show dialog
			dialog.classList.add('show');
			
			// Show loading
			dialogBody.innerHTML = '<div class="stock-price-dialog-loading">Loading...</div>';
			
			// Fetch data
			const apiPath = window.location.pathname.includes('/stock') ? './api/stock-price-info/' : '/api/stock-price-info/';
			fetch(apiPath + stockCode, {
				credentials: 'same-origin'
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success' && result.data) {
					const data = result.data;
					const html = `
						<div class="stock-price-info-item">
							<span class="stock-price-info-label">16-Day Highest Price:</span>
							<span class="stock-price-info-value">${data.high_16.toLocaleString()}</span>
						</div>
						<div class="stock-price-info-item">
							<span class="stock-price-info-label">16-Day Lowest Price:</span>
							<span class="stock-price-info-value">${data.low_16.toLocaleString()}</span>
						</div>
						<div class="stock-price-info-item">
							<span class="stock-price-info-label">Yellow Line Price:</span>
							<span class="stock-price-info-value">${data.yellow_line_price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
						</div>
						<div class="stock-price-info-item">
							<span class="stock-price-info-label">Current Price:</span>
							<span class="stock-price-info-value">${data.current_price.toLocaleString()}</span>
						</div>
						<div class="stock-price-info-item">
							<span class="stock-price-info-label">Gap:</span>
							<span class="stock-price-info-value">${data.gap.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
						</div>
						<div class="stock-price-info-item">
							<span class="stock-price-info-label">Gap Rate:</span>
							<span class="stock-price-info-value">${data.gap_rate.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
						</div>
					`;
					dialogBody.innerHTML = html;
				} else {
					dialogBody.innerHTML = `<div class="stock-price-dialog-error">Error: ${result.message || 'Unknown error'}</div>`;
				}
			})
			.catch(error => {
				console.error('Error fetching stock price info:', error);
				dialogBody.innerHTML = `<div class="stock-price-dialog-error">Error: ${error.message}</div>`;
			});
		}
		
		function closeStockPriceDialog() {
			const dialog = document.getElementById('stock-price-dialog');
			dialog.classList.remove('show');
		}
		
		// Close dialog when clicking outside
		window.onclick = function(event) {
			const dialog = document.getElementById('stock-price-dialog');
			if (event.target === dialog) {
				closeStockPriceDialog();
			}
		}

		
		function applySellPriceEdit(stockCode, stockName) {
			const sellPrice = document.getElementById(`edit-sell-price-${stockCode}`).value.trim();
			const sellRate = document.getElementById(`edit-sell-rate-${stockCode}`).value.trim();
			const sellgap = document.getElementById(`edit-sell-gap-${stockCode}`).value.trim();
			const bamount = document.getElementById(`edit-bamount-${stockCode}`).value.trim();
			
			// Prepare request data - use same format as interested-stocks endpoint
			const requestData = {
				stock_code: stockCode,
				stock_name: stockName || null,
				sellprice: sellPrice || '0',
				sellrate: sellRate || '0',
				sellgap: sellgap || '0',
				bamount: bamount || null
			};
			
			// Call API to update interested stocks (will create entry if doesn't exist)
			fetch('./api/interested-stocks', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(requestData)
			})
			.then(response => response.json())
			.then(result => {
				if (result.status === 'success') {
					showMessage('Sell price/rate/gap updated successfully!', 'success');
					// Remove the edit area
					const editArea = document.querySelector(`#edit-sell-price-${stockCode}`).closest('.sell-price-edit-area');
					if (editArea) {
						editArea.remove();
					}
					// Refresh the table and interested stocks list
					updateTable();
					updateInterestedStocks();
				} else {
					showMessage('Error: ' + (result.message || 'Failed to update'), 'error');
				}
			})
			.catch(error => {
				console.error('Error updating sell price:', error);
				showMessage('Error updating sell price: ' + error.message, 'error');
			});
		}
		
		function cancelSellPriceEdit(stockCode) {
			// Remove the edit area
			const editArea = document.querySelector(`#edit-sell-price-${stockCode}`).closest('.sell-price-edit-area');
			if (editArea) {
				editArea.remove();
			}
		}

		</script>
	
		<!-- Stock Price Info Dialog -->
		<div id="stock-price-dialog" class="stock-price-dialog">
			<div class="stock-price-dialog-content">
				<div class="stock-price-dialog-header">
					<h2 id="stock-price-dialog-title">Stock Price Information</h2>
					<span class="stock-price-dialog-close" onclick="closeStockPriceDialog()">&times;</span>
				</div>
				<div id="stock-price-dialog-body">
					<div class="stock-price-dialog-loading">Loading...</div>
				</div>
			</div>
		</div>

	</body>
	</html>
